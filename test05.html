<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Test05: Dungeon</title>
    <style>
        canvas {
            border: 1px solid black;
        }
        #status {
            font-family: monospace;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div id="status">HP: 50 | Gold: 0</div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');

        // プレイヤーの状態
        const player = {
            x: 0,
            y: 0,
            hp: 50,
            attack: 10,
            gold: 0,
            direction: 'north' // north, east, south, west
        };

        // 迷路 (1:壁, 0:通路, 2:宝箱, 3:モンスター)
        const maze = [
            [1, 1, 1, 1, 1],
            [1, 0, 0, 2, 1],
            [1, 0, 1, 0, 1],
            [1, 3, 0, 0, 1],
            [1, 1, 1, 1, 1]
        ];

        // モンスター（1種類）
        const monster = {
            hp: 20,
            attack: 5
        };

        // 画像のロード（プレースホルダーとして簡単な図形を使用）
        const treasureImg = new Image();
        treasureImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABYSURBVHhe7cEBAQAAAIIg/69uSEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM2g1O6gAB0K9x7wAAAABJRU5ErkJggg=='; // 金色の四角（宝箱）
        const monsterImg = new Image();
        monsterImg.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABaSURBVHhe7cEBAQAAAIIg/69uSEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM2g1O6gAB0Ldx7wAAAABJRU5ErkJggg=='; // 赤い四角（モンスター）

        // 描画関数
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 視界範囲（前方3マスを描画）
            const view = getView();
            const cellSize = 100;
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;

            // 壁とオブジェクトの描画
            for (let depth = 0; depth < 3; depth++) {
                const x = view[depth].x;
                const y = view[depth].y;
                if (x < 0 || x >= 5 || y < 0 || y >= 5) continue;

                const cell = maze[y][x];
                const offsetX = 100 + depth * 50;
                const offsetY = 100 + depth * 50;
                const size = 200 - depth * 50;

                if (cell === 1) {
                    // 壁（線画）
                    ctx.strokeRect(offsetX, offsetY, size, size);
                } else if (cell === 2) {
                    // 宝箱
                    ctx.drawImage(treasureImg, offsetX, offsetY, size, size);
                } else if (cell === 3) {
                    // モンスター
                    ctx.drawImage(monsterImg, offsetX, offsetY, size, size);
                }
            }

            // ステータス更新
            statusDiv.textContent = `HP: ${player.hp} | Gold: ${player.gold}`;
        }

        // 視界の取得
        function getView() {
            const view = [];
            let x = player.x;
            let y = player.y;
            let dx, dy;

            // 方向に応じた移動ベクトル
            switch (player.direction) {
                case 'north': dx = 0; dy = -1; break;
                case 'east': dx = 1; dy = 0; break;
                case 'south': dx = 0; dy = 1; break;
                case 'west': dx = -1; dy = 0; break;
            }

            // 前方3マスをチェック
            for (let i = 0; i < 3; i++) {
                x += dx;
                y += dy;
                view.push({ x, y });
            }
            return view;
        }

        // 移動処理
        function moveForward() {
            let newX = player.x;
            let newY = player.y;

            switch (player.direction) {
                case 'north': newY--; break;
                case 'east': newX++; break;
                case 'south': newY++; break;
                case 'west': newX--; break;
            }

            if (newX >= 0 && newX < 5 && newY >= 0 && newY < 5 && maze[newY][newX] !== 1) {
                player.x = newX;
                player.y = newY;
                if (maze[newY][newX] === 2) {
                    player.gold += 10;
                    maze[newY][newX] = 0; // 宝箱を消す
                } else if (maze[newY][newX] === 3) {
                    fightMonster();
                }
            }
            draw();
        }

        // 戦闘処理
        function fightMonster() {
            let monsterHp = monster.hp;
            while (monsterHp > 0 && player.hp > 0) {
                monsterHp -= player.attack;
                if (monsterHp > 0) {
                    player.hp -= monster.attack;
                }
            }
            if (monsterHp <= 0) {
                maze[player.y][player.x] = 0; // モンスターを消す
            }
            if (player.hp <= 0) {
                alert('ゲームオーバー！');
                player.hp = 50;
                player.x = 0;
                player.y = 0;
            }
            draw();
        }

        // 入力処理
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp': moveForward(); break;
                case 'ArrowLeft': player.direction = { north: 'west', east: 'north', south: 'east', west: 'south' }[player.direction]; draw(); break;
                case 'ArrowRight': player.direction = { north: 'east', east: 'south', south: 'west', west: 'north' }[player.direction]; draw(); break;
            }
        });

        // 初期描画
        draw();
    </script>
</body>
</html>